import 'dart:io';
import 'package:cowflies/image_select.dart';
import 'package:flutter/material.dart';
import 'package:geolocator/geolocator.dart';
import 'package:http/http.dart' as http;
import 'package:shared_preferences/shared_preferences.dart';

class SubmitAnimalForm extends StatefulWidget {
  final File image;
  final Function() onRetakeImage;
  final Function() toggleSubmit;
  final SharedPreferences prefs;

  const SubmitAnimalForm({
    super.key,
    required this.image,
    required this.onRetakeImage,
    required this.toggleSubmit,
    required this.prefs,
    required,
  });

  @override
  State<SubmitAnimalForm> createState() => _SubmitAnimalFormState();
}

class _SubmitAnimalFormState extends State<SubmitAnimalForm> {
  String? _animalId;
  bool? _softwareBackupSent;
  String? _sireId;
  int? _cowFlies;
  final _formKey = GlobalKey<FormState>();
  int? _cowValue;
  int? _lactationNumber;
  int? _ringworm;

  submit() async {
    widget.toggleSubmit();

    if (_formKey.currentState!.validate()) {
      final contextR = context;
      ScaffoldMessenger.of(
        contextR,
      ).showSnackBar(const SnackBar(content: Text("Submitting")));

      final loc = await getLocation();

      final uri = Uri.parse(
        "https://hiddenstring",
      ).replace(
        queryParameters: {
          "animalId": _animalId,
          "softwareBackupSent": _softwareBackupSent.toString(),
          "sireId": _sireId,
          "cowFlies": _cowFlies == null ? "" : _cowFlies.toString(),
          "cowValue": _cowValue == null ? "" : _cowValue.toString(),
          "lactationNumber":
              _lactationNumber == null ? "" : _lactationNumber.toString(),
          "long": loc == null ? "" : loc.longitude.toString(),
          "lat": loc == null ? "" : loc.latitude.toString(),
        },
      );

      http.MultipartRequest request = http.MultipartRequest("POST", uri);
      request.files.add(
        await http.MultipartFile.fromPath("image", widget.image.path),
      );

      http.StreamedResponse response = await request.send();

      if (response.statusCode != 200) {
        if (contextR.mounted) {
          ScaffoldMessenger.of(contextR).removeCurrentSnackBar();
          ScaffoldMessenger.of(contextR).showSnackBar(
            const SnackBar(
              content: Text(
                "An error occurred when submitting this animal. Please try again later.",
              ),
            ),
          );
        }
      } else {
        if (contextR.mounted) {
          widget.onRetakeImage();
          ScaffoldMessenger.of(contextR).removeCurrentSnackBar();
          ScaffoldMessenger.of(
            contextR,
          ).showSnackBar(const SnackBar(content: Text("Animal submitted.")));
        }
      }
    }

    widget.toggleSubmit();
  }

  Future<Position?> getLocation() async {
    if (!await Geolocator.isLocationServiceEnabled()) {
      return null;
    }

    LocationPermission permissionStatus = await Geolocator.checkPermission();
    if (permissionStatus == LocationPermission.deniedForever) {
      return null;
    }

    if (permissionStatus == LocationPermission.denied) {
      permissionStatus = await Geolocator.requestPermission();
      if (permissionStatus == LocationPermission.denied) {
        return null;
      }
    }

    return await Geolocator.getCurrentPosition();
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: Padding(
        padding: const EdgeInsets.all(16.0),
        child: SingleChildScrollView(
          child: Column(
            spacing: 10.0,
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Image.file(widget.image),
              SizedBox(
                width: double.infinity,
                child: TextButton(
                  onPressed: widget.onRetakeImage,
                  style: buttonStyle,
                  child: Text("Retake Image"),
                ),
              ),
              Form(
                key: _formKey,
                child: Column(
                  spacing: 10.0,
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    TextFormField(
                      decoration: InputDecoration(labelText: "*Animal Id/Name"),
                      autocorrect: false,
                      onChanged: (value) {
                        setState(() {
                          _animalId = value;
                        });
                      },
                      validator: (value) {
                        if (value == null || value.isEmpty) {
                          return "This field is required.";
                        }
                        return null;
                      },
                    ),

                    /// Software backup / Sire id
                    DropdownButtonFormField(
                      decoration: InputDecoration(
                        labelText:
                            "*Did you send a software backup for your farm?",
                      ),
                      value: _softwareBackupSent,
                      onChanged:
                          (value) => setState(() {
                            _softwareBackupSent = value ?? false;
                          }),
                      items: [
                        DropdownMenuItem(value: true, child: Text("Yes")),
                        DropdownMenuItem(value: false, child: Text("No")),
                      ],
                      validator: (value) {
                        if (value == null) {
                          return "This field is required.";
                        }

                        return null;
                      },
                    ),
                    TextFormField(
                      decoration: InputDecoration(
                        labelText:
                            "${_softwareBackupSent == false ? '*' : ''}Sire Id/Name",
                      ),
                      autocorrect: false,
                      onChanged:
                          (value) => setState(() {
                            _sireId = value;
                          }),
                      validator: (value) {
                        if (value == null || value.isEmpty) {
                          if (_softwareBackupSent == false) {
                            return "This field is required if software backup is not sent.";
                          }
                        }
                        return null;
                      },
                    ),

                    /// How many flies are on this cow
                    DropdownButtonFormField(
                      decoration: InputDecoration(
                        labelText: "How many flies does this animal have?",
                      ),
                      value: _cowFlies,
                      items: const [
                        DropdownMenuItem(value: 1, child: Text("None")),
                        DropdownMenuItem(value: 2, child: Text("Few")),
                        DropdownMenuItem(value: 3, child: Text("Moderate")),
                        DropdownMenuItem(value: 4, child: Text("Many")),
                        DropdownMenuItem(value: 5, child: Text("Heavy")),
                      ],
                      onChanged:
                          (value) => setState(() {
                            _cowFlies = value;
                          }),
                    ),

                    /// Lactation #
                    DropdownButtonFormField(
                      items: [
                        DropdownMenuItem(
                          value: 0,
                          child: Text("No Lactations"),
                        ),
                        DropdownMenuItem(
                          value: 1,
                          child: Text("First Lactation"),
                        ),
                        DropdownMenuItem(
                          value: 2,
                          child: Text("No Second Lactation"),
                        ),
                        DropdownMenuItem(
                          value: 3,
                          child: Text("Third Lactation"),
                        ),
                        DropdownMenuItem(
                          value: 4,
                          child: Text("Fourth Lactation"),
                        ),
                        DropdownMenuItem(
                          value: 5,
                          child: Text("5+ Lactations"),
                        ),
                      ],
                      onChanged:
                          (value) => setState(() {
                            _lactationNumber = value;
                            if (value == 0) {
                              _cowValue = null;
                            } else {
                              _ringworm = null;
                            }
                          }),
                    ),

                    /// I like this cow / Ringworm
                    _lactationNumber == 0
                        ? DropdownButtonFormField(
                          items: [
                            DropdownMenuItem(child: Text("Yes"))
                          ],
                          onChanged: (value) => setState(() {
                            _ringworm = value;
                          });,
                        )
                        : DropdownButtonFormField(
                          decoration: InputDecoration(
                            labelText: "How much do you like this animal?",
                          ),

                          value: _cowValue,
                          items: const [
                            DropdownMenuItem(
                              value: 1,
                              child: Text("Strongly Dislike"),
                            ),
                            DropdownMenuItem(value: 2, child: Text("Dislike")),
                            DropdownMenuItem(
                              value: 3,
                              child: Text("Indifferent"),
                            ),
                            DropdownMenuItem(value: 4, child: Text("Like")),
                            DropdownMenuItem(
                              value: 5,
                              child: Text("Strongly Like"),
                            ),
                          ],
                          onChanged:
                              (value) => setState(() {
                                _cowValue = value;
                              }),
                        ),

                    SizedBox(height: 20),
                    SizedBox(
                      width: double.infinity,
                      child: ElevatedButton(
                        onPressed: submit,
                        style: buttonStyle,
                        child: Text("Submit"),
                      ),
                    ),
                  ],
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }
}
